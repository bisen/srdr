<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: SearchController
  
    &mdash; Documentation by YARD 0.7.4
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (S)</a> &raquo; 
    
    
    <span class="title">SearchController</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: SearchController
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActionController::Base</li>
          
            <li class="next"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></li>
          
            <li class="next">SearchController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/controllers/search_controller.rb</dd>
  
</dl>
<div class="clear"></div>



  
  
  
  
  


  
  
  
  

  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_study_info-instance_method" title="#get_study_info (instance method)">- (Object) <strong>get_study_info</strong>(publications) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
get_study_info return the project_id and study_type fields for the studies
linked to the primary publications
--------------------------------------------------------------------------------------.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#index-instance_method" title="#index (instance method)">- (Object) <strong>index</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
index display search page.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_dups-instance_method" title="#remove_dups (instance method)">- (Object) <strong>remove_dups</strong>(projects) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
remove_dups return only unique projects in the projects list
--------------------------------------------------------------------------------------.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#results-instance_method" title="#results (instance method)">- (Object) <strong>results</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
results display search results page	 resultslist is a Hash[<project id>] =>
Array[Array[<word code>],<match score>].
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search_bubblesort-instance_method" title="#search_bubblesort (instance method)">- (Object) <strong>search_bubblesort</strong>(projlist) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
Bubble sort an array of project matches  Float the highest hit score record
up to the top projlist is a Array[<hit score>,<Project>]  
------------------------------------------------------------------------------------------------.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search_database-instance_method" title="#search_database (instance method)">- (Object) <strong>search_database</strong>(groupid, query_array, is_public_search) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
Search - general search: which assumes only common database table columns
are included in the search.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search_for_projects-instance_method" title="#search_for_projects (instance method)">- (Object) <strong>search_for_projects</strong>(query_array) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
method to search for projecs based on the query_array
--------------------------------------------------------------------------------------.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search_for_publications-instance_method" title="#search_for_publications (instance method)">- (Object) <strong>search_for_publications</strong>(query_array) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
method to search for study publications based on the query_array
--------------------------------------------------------------------------------------.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search_projects-instance_method" title="#search_projects (instance method)">- (Object) <strong>search_projects</strong>(query_array, groupid, target_ids, is_public_search) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
search_for_projects method to search for systematic review projects based
on the query_array generalized search method with specified table column
names provided in array target_ids  results are ranked ordered - with [0]
having the highest hit score, [n] having the lowest   
------------------------------------------------------------------------------------------------.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#toContextText-instance_method" title="#toContextText (instance method)">- (Object) <strong>toContextText</strong>(tdata, q1) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><hr style="height: 10px"></hr><p>
Produce context text where q1 and/or q2 was found in tdata   
------------------------------------------------------------------------------------------------.
</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ApplicationController.html#escape_quotes-instance_method" title="ApplicationController#escape_quotes (method)">#escape_quotes</a></span>, <span class='object_link'><a href="ApplicationController.html#set_as_current-instance_method" title="ApplicationController#set_as_current (method)">#set_as_current</a></span>, <span class='object_link'><a href="ApplicationController.html#show_other-instance_method" title="ApplicationController#show_other (method)">#show_other</a></span>, <span class='object_link'><a href="ApplicationController.html#show_other_filled-instance_method" title="ApplicationController#show_other_filled (method)">#show_other_filled</a></span>, <span class='object_link'><a href="ApplicationController.html#toggle_ahrq_header-instance_method" title="ApplicationController#toggle_ahrq_header (method)">#toggle_ahrq_header</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="get_study_info-instance_method">
  
    - (<tt>Object</tt>) <strong>get_study_info</strong>(publications) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
get_study_info return the project_id and study_type fields for the studies
linked to the primary publications
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


413
414
415
416
417
418
419
420
421
422
423
424
425</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 413</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_study_info'>get_study_info</span><span class='lparen'>(</span><span class='id identifier rubyid_publications'>publications</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_publications'>publications</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pub'>pub</span><span class='op'>|</span>
	  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
			<span class='kw'>begin</span>
				<span class='id identifier rubyid_tmp_study'>tmp_study</span> <span class='op'>=</span> <span class='const'>Study</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span><span class='rparen'>)</span>
				<span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_tmp_study'>tmp_study</span><span class='period'>.</span><span class='id identifier rubyid_study_type'>study_type</span><span class='comma'>,</span> <span class='id identifier rubyid_tmp_study'>tmp_study</span><span class='period'>.</span><span class='id identifier rubyid_project_id'>project_id</span><span class='rbracket'>]</span>
			<span class='kw'>rescue</span>
			<span class='kw'>end</span>
	  <span class='kw'>end</span>
	<span class='kw'>end</span>
	<span class='kw'>return</span> <span class='id identifier rubyid_ret_arr'>ret_arr</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="index-instance_method">
  
    - (<tt>Object</tt>) <strong>index</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
index display search page
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


5
6
7</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 5</span>

<span class='kw'>def</span> <span class='id identifier rubyid_index'>index</span>
    <span class='ivar'>@page_title</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Search</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="remove_dups-instance_method">
  
    - (<tt>Object</tt>) <strong>remove_dups</strong>(projects) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
remove_dups return only unique projects in the projects list
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


431
432
433
434</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 431</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_dups'>remove_dups</span><span class='lparen'>(</span><span class='id identifier rubyid_projects'>projects</span><span class='rparen'>)</span>
	 <span class='id identifier rubyid_projects'>projects</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span> <span class='comment'>#=&gt; projects
</span>	 <span class='kw'>return</span> <span class='id identifier rubyid_projects'>projects</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="results-instance_method">
  
    - (<tt>Object</tt>) <strong>results</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
results display search results page	 resultslist is a Hash[<project id>] =>
Array[Array[<word code>],<match score>]
</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 12</span>

<span class='kw'>def</span> <span class='id identifier rubyid_results'>results</span>
    <span class='id identifier rubyid_query_string'>query_string</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_query_string'>query_string</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:user_input</span><span class='rbracket'>]</span>
    
           <span class='comment'># split search text into individual words    
</span>    <span class='ivar'>@query</span> <span class='op'>=</span> <span class='id identifier rubyid_query_string'>query_string</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='rparen'>)</span>
           <span class='id identifier rubyid_is_public_search'>is_public_search</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
           
           <span class='comment'># load search parameters
</span>           <span class='ivar'>@resultslist</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
           <span class='id identifier rubyid_properties'>properties</span> <span class='op'>=</span> <span class='const'>YAML</span><span class='period'>.</span><span class='id identifier rubyid_load_file'>load_file</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>properties/search.properties</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
           <span class='id identifier rubyid_properties'>properties</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>search-groups</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_groupid'>groupid</span><span class='op'>|</span>
               <span class='comment'># puts &quot;&gt;&gt;&gt; group id &quot;+groupid[0].to_s
</span>               <span class='ivar'>@resultslist</span><span class='lbracket'>[</span><span class='id identifier rubyid_groupid'>groupid</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_search_database'>search_database</span><span class='lparen'>(</span><span class='id identifier rubyid_groupid'>groupid</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='ivar'>@query</span><span class='comma'>,</span><span class='id identifier rubyid_is_public_search'>is_public_search</span><span class='rparen'>)</span>
           <span class='kw'>end</span>
           <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@query</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='ivar'>@page_title</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Search Results for \&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='ivar'>@query</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\&quot;</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
       	<span class='ivar'>@page_title</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Search Results</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
           <span class='ivar'>@proj_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='semicolon'>;</span>
           <span class='ivar'>@publications_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='semicolon'>;</span>
           <span class='ivar'>@study_info_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='semicolon'>;</span>
           <span class='comment'># puts &quot;results hash table &quot;+@resultslist.to_s
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="search_bubblesort-instance_method">
  
    - (<tt>Object</tt>) <strong>search_bubblesort</strong>(projlist) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
Bubble sort an array of project matches  Float the highest hit score record
up to the top projlist is a Array[<hit score>,<Project>]  
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 73</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search_bubblesort'>search_bubblesort</span><span class='lparen'>(</span><span class='id identifier rubyid_projlist'>projlist</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_sortedlist'>sortedlist</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_projlist'>projlist</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
        <span class='kw'>while</span> <span class='id identifier rubyid_projlist'>projlist</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span> <span class='kw'>do</span>
            <span class='id identifier rubyid_idx'>idx</span> <span class='op'>=</span> <span class='int'>0</span>
            <span class='id identifier rubyid_projresult1'>projresult1</span> <span class='op'>=</span> <span class='id identifier rubyid_projlist'>projlist</span><span class='lbracket'>[</span><span class='id identifier rubyid_idx'>idx</span><span class='rbracket'>]</span>
            <span class='id identifier rubyid_hitscore'>hitscore</span> <span class='op'>=</span> <span class='id identifier rubyid_projresult1'>projresult1</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
            <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='int'>1</span>
            <span class='kw'>while</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_projlist'>projlist</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='kw'>do</span>
                <span class='id identifier rubyid_projresult2'>projresult2</span> <span class='op'>=</span> <span class='id identifier rubyid_projlist'>projlist</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span>
                <span class='id identifier rubyid_hitscore2'>hitscore2</span> <span class='op'>=</span> <span class='id identifier rubyid_projresult2'>projresult2</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
                <span class='kw'>if</span> <span class='id identifier rubyid_hitscore2'>hitscore2</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_hitscore'>hitscore</span>
                    <span class='id identifier rubyid_hitscore'>hitscore</span> <span class='op'>=</span> <span class='id identifier rubyid_hitscore2'>hitscore2</span>
                    <span class='id identifier rubyid_projresult1'>projresult1</span> <span class='op'>=</span> <span class='id identifier rubyid_projresult2'>projresult2</span>
                    <span class='id identifier rubyid_idx'>idx</span> <span class='op'>=</span> <span class='id identifier rubyid_i'>i</span>
                <span class='kw'>end</span>
    
                <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span>
            <span class='kw'>end</span>
            <span class='comment'># projresult1 has the smallest hit score
</span>            <span class='comment'># save the Project object in the sorted list
</span>            <span class='id identifier rubyid_sortedlist'>sortedlist</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_projresult1'>projresult1</span>
            
            <span class='comment'># remove projresult1 from the source list
</span>            <span class='id identifier rubyid_projlist'>projlist</span><span class='period'>.</span><span class='id identifier rubyid_delete_at'>delete_at</span><span class='lparen'>(</span><span class='id identifier rubyid_idx'>idx</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
    <span class='kw'>end</span>
    
    <span class='kw'>return</span> <span class='id identifier rubyid_sortedlist'>sortedlist</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="search_database-instance_method">
  
    - (<tt>Object</tt>) <strong>search_database</strong>(groupid, query_array, is_public_search) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
Search - general search: which assumes only common database table columns
are included in the search
</p>
<pre class="code">
    each search item is scored based on potential relevance - creating an overall score used to sort best hit
    general search inlcudes: Project - title (10), description (5), funding_source (5), creator_id (5)
    for each word assess hit score. If there is a hit and also hit the previous word - give bonus points to the hit score
</pre>
<p>
method for general search based on the query_array	
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 45</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search_database'>search_database</span><span class='lparen'>(</span><span class='id identifier rubyid_groupid'>groupid</span><span class='comma'>,</span><span class='id identifier rubyid_query_array'>query_array</span><span class='comma'>,</span><span class='id identifier rubyid_is_public_search'>is_public_search</span><span class='rparen'>)</span>
         <span class='id identifier rubyid_properties'>properties</span> <span class='op'>=</span> <span class='const'>YAML</span><span class='period'>.</span><span class='id identifier rubyid_load_file'>load_file</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>properties/search.properties</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
         <span class='id identifier rubyid_target_ids'>target_ids</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
         <span class='id identifier rubyid_properties'>properties</span><span class='lbracket'>[</span><span class='id identifier rubyid_groupid'>groupid</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>-general</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_targetid'>targetid</span><span class='op'>|</span>
             <span class='id identifier rubyid_target_ids'>target_ids</span> <span class='op'>=</span> <span class='id identifier rubyid_target_ids'>target_ids</span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id identifier rubyid_targetid'>targetid</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span>
         <span class='kw'>end</span>
         <span class='comment'># puts &quot;&gt;&gt;&gt;&gt; loaded group id &quot;+groupid.to_s+&quot; got targets &quot;+target_ids.to_s
</span>
         <span class='comment'># searchresults is formatted as a hash[Project.id][Array[&lt;hit score&gt;, &lt;Project&gt;]]
</span>  <span class='id identifier rubyid_searchresults'>searchresults</span> <span class='op'>=</span> <span class='id identifier rubyid_search_projects'>search_projects</span><span class='lparen'>(</span><span class='ivar'>@query</span><span class='comma'>,</span><span class='id identifier rubyid_groupid'>groupid</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_target_ids'>target_ids</span><span class='comma'>,</span><span class='id identifier rubyid_is_public_search'>is_public_search</span><span class='rparen'>)</span>
         
         <span class='comment'># convert searchresults into an array of [&lt;hit score&gt;,&lt;Project&gt;]
</span>         <span class='id identifier rubyid_searcharr'>searcharr</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
         <span class='id identifier rubyid_searchresults'>searchresults</span><span class='period'>.</span><span class='id identifier rubyid_each_value'>each_value</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_searcharr'>searcharr</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_v'>v</span><span class='rbrace'>}</span>
         <span class='comment'># puts &quot;...converted to an array &quot;+searcharr.to_s
</span>         
         <span class='comment'># Now sort by hitscore - [0] is the highest, [n] is the lowest
</span>         <span class='comment'># Sort the projects into an Array[Project] by the hitscore
</span>         <span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>=</span> <span class='id identifier rubyid_search_bubblesort'>search_bubblesort</span><span class='lparen'>(</span><span class='id identifier rubyid_searcharr'>searcharr</span><span class='rparen'>)</span>
         
 	  <span class='kw'>return</span> <span class='id identifier rubyid_ret_arr'>ret_arr</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="search_for_projects-instance_method">
  
    - (<tt>Object</tt>) <strong>search_for_projects</strong>(query_array) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
method to search for projecs based on the query_array
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


374
375
376
377
378
379
380
381
382
383
384
385</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 374</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search_for_projects'>search_for_projects</span><span class='lparen'>(</span><span class='id identifier rubyid_query_array'>query_array</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_query_array'>query_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_q'>q</span><span class='op'>|</span>
		<span class='id identifier rubyid_q'>q</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_q'>q</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_tmp_proj'>tmp_proj</span> <span class='op'>=</span> <span class='const'>Project</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>(title LIKE ? OR description LIKE ?) AND is_public = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_q'>q</span><span class='comma'>,</span> <span class='id identifier rubyid_q'>q</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>t</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
		<span class='kw'>for</span> <span class='id identifier rubyid_proj'>proj</span> <span class='kw'>in</span> <span class='id identifier rubyid_tmp_proj'>tmp_proj</span>
			<span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_proj'>proj</span>
		<span class='kw'>end</span>
	<span class='kw'>end</span>
	<span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_dups'>remove_dups</span><span class='lparen'>(</span><span class='id identifier rubyid_ret_arr'>ret_arr</span><span class='rparen'>)</span>
	<span class='kw'>return</span> <span class='id identifier rubyid_ret_arr'>ret_arr</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="search_for_publications-instance_method">
  
    - (<tt>Object</tt>) <strong>search_for_publications</strong>(query_array) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
method to search for study publications based on the query_array
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 390</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search_for_publications'>search_for_publications</span><span class='lparen'>(</span><span class='id identifier rubyid_query_array'>query_array</span><span class='rparen'>)</span>
	<span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_query_array'>query_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_q'>q</span><span class='op'>|</span>
		<span class='id identifier rubyid_q'>q</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_q'>q</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_tmp_pub'>tmp_pub</span> <span class='op'>=</span> <span class='const'>PrimaryPublication</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span><span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>is_public = 't' AND (title LIKE ? OR author LIKE ? or country LIKE ? or year LIKE ?)</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='id identifier rubyid_q'>q</span><span class='comma'>,</span><span class='id identifier rubyid_q'>q</span><span class='comma'>,</span><span class='id identifier rubyid_q'>q</span><span class='comma'>,</span><span class='id identifier rubyid_q'>q</span><span class='rbracket'>]</span><span class='rparen'>)</span>
		<span class='kw'>for</span> <span class='id identifier rubyid_pub'>pub</span> <span class='kw'>in</span> <span class='id identifier rubyid_tmp_pub'>tmp_pub</span>
			<span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
				<span class='id identifier rubyid_study'>study</span> <span class='op'>=</span> <span class='const'>Study</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span><span class='comma'>,</span> <span class='symbol'>:select</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>project_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
				<span class='id identifier rubyid_project'>project</span> <span class='op'>=</span> <span class='const'>Project</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_study'>study</span><span class='period'>.</span><span class='id identifier rubyid_project_id'>project_id</span><span class='comma'>,</span> <span class='symbol'>:select</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>is_public</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
				<span class='kw'>if</span> <span class='id identifier rubyid_project'>project</span><span class='period'>.</span><span class='id identifier rubyid_is_public'>is_public</span>
					<span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_pub'>pub</span>
				<span class='kw'>end</span>
			<span class='kw'>end</span>
		<span class='kw'>end</span>
	<span class='kw'>end</span>
	<span class='id identifier rubyid_ret_arr'>ret_arr</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_dups'>remove_dups</span><span class='lparen'>(</span><span class='id identifier rubyid_ret_arr'>ret_arr</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_ret_arr'>ret_arr</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="search_projects-instance_method">
  
    - (<tt>Object</tt>) <strong>search_projects</strong>(query_array, groupid, target_ids, is_public_search) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
search_for_projects method to search for systematic review projects based
on the query_array generalized search method with specified table column
names provided in array target_ids  results are ranked ordered - with [0]
having the highest hit score, [n] having the lowest   
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 175</span>

<span class='kw'>def</span> <span class='id identifier rubyid_search_projects'>search_projects</span><span class='lparen'>(</span><span class='id identifier rubyid_query_array'>query_array</span><span class='comma'>,</span><span class='id identifier rubyid_groupid'>groupid</span><span class='comma'>,</span><span class='id identifier rubyid_target_ids'>target_ids</span><span class='comma'>,</span><span class='id identifier rubyid_is_public_search'>is_public_search</span><span class='rparen'>)</span>
         <span class='id identifier rubyid_properties'>properties</span> <span class='op'>=</span> <span class='const'>YAML</span><span class='period'>.</span><span class='id identifier rubyid_load_file'>load_file</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>properties/search.properties</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
         <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>... in search_projects</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_ret_projs'>ret_projs</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
         
         <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='semicolon'>;</span>
         <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
             <span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
             <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; user id </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_user_id'>user_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
         <span class='kw'>end</span>
         
  <span class='id identifier rubyid_target_ids'>target_ids</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
             <span class='comment'># Get the term score - value is formatted as &lt;score&gt;, &lt;desc&gt;
</span>             <span class='id identifier rubyid_tv'>tv</span> <span class='op'>=</span> <span class='id identifier rubyid_properties'>properties</span><span class='lbracket'>[</span><span class='id identifier rubyid_groupid'>groupid</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-general</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_t'>t</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
             <span class='id identifier rubyid_tscore'>tscore</span> <span class='op'>=</span> <span class='id identifier rubyid_tv'>tv</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
             <span class='id identifier rubyid_tdesc'>tdesc</span> <span class='op'>=</span> <span class='id identifier rubyid_tv'>tv</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
             <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.... looking at term </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_t'>t</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> value </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_tv'>tv</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> score </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_tscore'>tscore</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
             
             <span class='comment'># search for query words in the order &quot;w1 w2 .. w(n)&quot;, then &quot;w1 w2 ... w(n-1)&quot; - the longer the sequence, the higher the score
</span>             <span class='id identifier rubyid_n_words'>n_words</span> <span class='op'>=</span> <span class='id identifier rubyid_query_array'>query_array</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
             <span class='comment'># count characters in array - used to score by word length
</span>             <span class='id identifier rubyid_n_chars'>n_chars</span> <span class='op'>=</span> <span class='int'>0</span>
             <span class='id identifier rubyid_query_array'>query_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_q'>q</span><span class='op'>|</span>
                 <span class='id identifier rubyid_n_chars'>n_chars</span> <span class='op'>=</span> <span class='id identifier rubyid_n_chars'>n_chars</span> <span class='op'>+</span> <span class='id identifier rubyid_q'>q</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
             <span class='kw'>end</span>
             
             <span class='id identifier rubyid_qstr'>qstr</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
             <span class='id identifier rubyid_hitscore'>hitscore</span> <span class='op'>=</span> <span class='int'>0</span>
             <span class='comment'># until i &gt;= n_words
</span>             <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='int'>0</span>
             <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>... starting string group search i=</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> n_words=</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_n_words'>n_words</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> and qstr = </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> is public </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_is_public_search'>is_public_search</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
             <span class='lparen'>(</span>
                 <span class='id identifier rubyid_k'>k</span> <span class='op'>=</span> <span class='int'>0</span>
                 <span class='kw'>while</span> <span class='id identifier rubyid_k'>k</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_i'>i</span> <span class='kw'>do</span>
                     <span class='id identifier rubyid_j'>j</span> <span class='op'>=</span> <span class='int'>0</span>
                     <span class='id identifier rubyid_qstr'>qstr</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
                     <span class='lparen'>(</span>
                         <span class='kw'>if</span> <span class='id identifier rubyid_j'>j</span> <span class='op'>&gt;</span> <span class='int'>0</span>
                             <span class='id identifier rubyid_qstr'>qstr</span> <span class='op'>=</span> <span class='id identifier rubyid_qstr'>qstr</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span>
                         <span class='kw'>end</span>
                         <span class='id identifier rubyid_qstr'>qstr</span> <span class='op'>=</span> <span class='id identifier rubyid_qstr'>qstr</span> <span class='op'>+</span> <span class='id identifier rubyid_query_array'>query_array</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span> <span class='op'>+</span> <span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span>
                         <span class='id identifier rubyid_j'>j</span> <span class='op'>=</span> <span class='id identifier rubyid_j'>j</span> <span class='op'>+</span> <span class='int'>1</span>
                     <span class='rparen'>)</span> <span class='kw'>until</span> <span class='id identifier rubyid_j'>j</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_n_words'>n_words</span> <span class='op'>-</span> <span class='id identifier rubyid_i'>i</span>
   	              <span class='id identifier rubyid_q1'>q1</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>% </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span>
   	              <span class='id identifier rubyid_q2'>q2</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> %</span><span class='tstring_end'>&quot;</span></span>
                     <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>... sql (</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE '</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_q1'>q1</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>' OR </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE '</span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_q2'>q2</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>')</span><span class='tstring_end'>&quot;</span></span>
                     <span class='id identifier rubyid_tmp_proj'>tmp_proj</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
                     <span class='kw'>if</span> <span class='id identifier rubyid_groupid'>groupid</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>projects</span><span class='tstring_end'>&quot;</span></span>
                         <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...searching Projects</span><span class='tstring_end'>&quot;</span></span>
   	                  <span class='id identifier rubyid_tmp_prj'>tmp_prj</span> <span class='op'>=</span> <span class='const'>Project</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE ? OR </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_q1'>q1</span><span class='comma'>,</span><span class='id identifier rubyid_q2'>q2</span><span class='rbracket'>]</span><span class='rparen'>)</span>
   		          <span class='kw'>for</span> <span class='id identifier rubyid_prj'>prj</span> <span class='kw'>in</span> <span class='id identifier rubyid_tmp_prj'>tmp_prj</span>
                             <span class='comment'># Pickup project information - creator, create date, etc
</span>       	              <span class='id identifier rubyid_userinfo'>userinfo</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:first</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_creator_id'>creator_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                             <span class='comment'># If a public search - only allow Project.is_public = boolean [f | t]
</span>                             <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;&gt;&gt;---------------------------------------------------------------------------------------------</span><span class='tstring_end'>&quot;</span></span>
                             <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;&gt;&gt; got prj prior to public screen </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> is_public </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_is_public'>is_public</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> is_public_search </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_is_public_search'>is_public_search</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
                             <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_is_public_search'>is_public_search</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_user_id'>user_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>==</span> <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_creator_id'>creator_id</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>||</span>
                                <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_is_public'>is_public</span>
                                 <span class='comment'># construct the search hit context text
</span>                                 <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='semicolon'>;</span>
                                 <span class='kw'>if</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span>
                                     <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                                 <span class='kw'>elsif</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>description</span><span class='tstring_end'>&quot;</span></span>
                                     <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_description'>description</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                                 <span class='kw'>elsif</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>funding_source</span><span class='tstring_end'>&quot;</span></span>
                                     <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_funding_source'>funding_source</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                                 <span class='kw'>elsif</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>notes</span><span class='tstring_end'>&quot;</span></span>
                                     <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_notes'>notes</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                                 <span class='kw'>end</span>
                                 <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>::::::::::::::: qtext </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_qtext'>qtext</span>
                                 <span class='comment'># Pickup the study_id so we can pull associated primary and secondary publications
</span>       	                  <span class='id identifier rubyid_study'>study</span> <span class='op'>=</span> <span class='const'>Study</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:first</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>project_id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                                 <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_study'>study</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
       	                      <span class='id identifier rubyid_prim_pub'>prim_pub</span> <span class='op'>=</span> <span class='const'>PrimaryPublication</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:order</span><span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>year</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>study_id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_study'>study</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                                     <span class='id identifier rubyid_tmp_proj'>tmp_proj</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_prj'>prj</span><span class='comma'>,</span><span class='id identifier rubyid_qtext'>qtext</span><span class='comma'>,</span><span class='id identifier rubyid_study'>study</span><span class='comma'>,</span><span class='id identifier rubyid_prim_pub'>prim_pub</span><span class='comma'>,</span><span class='id identifier rubyid_tdesc'>tdesc</span><span class='comma'>,</span><span class='id identifier rubyid_userinfo'>userinfo</span><span class='rbracket'>]</span>
                                 <span class='kw'>else</span>
                                     <span class='id identifier rubyid_tmp_proj'>tmp_proj</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_prj'>prj</span><span class='comma'>,</span><span class='id identifier rubyid_qtext'>qtext</span><span class='comma'>,</span><span class='kw'>nil</span><span class='comma'>,</span><span class='kw'>nil</span><span class='comma'>,</span><span class='id identifier rubyid_tdesc'>tdesc</span><span class='comma'>,</span><span class='id identifier rubyid_userinfo'>userinfo</span><span class='rbracket'>]</span>
                                 <span class='kw'>end</span>
                             <span class='kw'>end</span>
                         <span class='kw'>end</span>
                     <span class='kw'>elsif</span> <span class='id identifier rubyid_groupid'>groupid</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>publications</span><span class='tstring_end'>&quot;</span></span>
                         <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...searching Publications</span><span class='tstring_end'>&quot;</span></span>
   		          <span class='id identifier rubyid_tmp_pub'>tmp_pub</span> <span class='op'>=</span> <span class='const'>PrimaryPublication</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span><span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE ? OR </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_q1'>q1</span><span class='comma'>,</span><span class='id identifier rubyid_q2'>q2</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                         <span class='comment'># Now iterate through all the publication hits to pull the associated Project and save the project record
</span>                         <span class='comment'># Publication.study_id is linked to a Study, use the Study.project_id then to get the Project record
</span>                         <span class='kw'>for</span> <span class='id identifier rubyid_pub'>pub</span> <span class='kw'>in</span> <span class='id identifier rubyid_tmp_pub'>tmp_pub</span>
   		              <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
                                 <span class='comment'># construct the search hit context text
</span>                                 <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='semicolon'>;</span>
                                 <span class='kw'>if</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span>
                                     <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                                 <span class='kw'>elsif</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>author</span><span class='tstring_end'>&quot;</span></span>
                                     <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_author'>author</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                                 <span class='kw'>elsif</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pmid</span><span class='tstring_end'>&quot;</span></span>
                                     <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_pmid'>pmid</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                                 <span class='kw'>end</span>
                                 <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>::::::::::::::: qtext </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_qtext'>qtext</span>
                                 
   	                          <span class='id identifier rubyid_study'>study</span> <span class='op'>=</span> <span class='const'>Study</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:first</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_pub'>pub</span><span class='period'>.</span><span class='id identifier rubyid_study_id'>study_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                                 <span class='comment'># Ok - got the Study associated with the publication, now get the Project associated with the Study
</span>                                 <span class='comment'># gather projects that meet public/non-public search criteria into an array
</span>                                 <span class='id identifier rubyid_tmp_prjs'>tmp_prjs</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
   	                          <span class='id identifier rubyid_tmp_prj'>tmp_prj</span> <span class='op'>=</span> <span class='const'>Project</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:order</span><span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>created_at</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_study'>study</span><span class='period'>.</span><span class='id identifier rubyid_project_id'>project_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
   		                  <span class='kw'>for</span> <span class='id identifier rubyid_prj'>prj</span> <span class='kw'>in</span> <span class='id identifier rubyid_tmp_prj'>tmp_prj</span>
                                     <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_is_public_search'>is_public_search</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_user_id'>user_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>==</span> <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_creator_id'>creator_id</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>||</span>
                                        <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_is_public'>is_public</span>
                                         <span class='comment'># If a public search - only allow Project.is_public = boolean [f | t]
</span>                                         <span class='comment'># Pickup project information - creator, create date, etc
</span>       	                          <span class='id identifier rubyid_userinfo'>userinfo</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:first</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_creator_id'>creator_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                                         <span class='id identifier rubyid_tmp_prjs'>tmp_prjs</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_prj'>prj</span><span class='comma'>,</span><span class='id identifier rubyid_userinfo'>userinfo</span><span class='rbracket'>]</span>
                                     <span class='kw'>end</span>
                                 <span class='kw'>end</span>
                                 <span class='comment'># Tag the publication with the first project and carry along the entire list of associated projects
</span>                                 <span class='kw'>if</span> <span class='id identifier rubyid_tmp_prjs'>tmp_prjs</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='int'>0</span>
                                     <span class='id identifier rubyid_tmp_proj'>tmp_proj</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_tmp_prjs'>tmp_prjs</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_qtext'>qtext</span><span class='comma'>,</span><span class='id identifier rubyid_study'>study</span><span class='comma'>,</span><span class='lbracket'>[</span><span class='id identifier rubyid_pub'>pub</span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_tdesc'>tdesc</span><span class='comma'>,</span><span class='id identifier rubyid_tmp_prjs'>tmp_prjs</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='comma'>,</span><span class='id identifier rubyid_tmp_prjs'>tmp_prjs</span><span class='rbracket'>]</span>
                                 <span class='kw'>end</span>
   			      <span class='kw'>end</span>
                         <span class='kw'>end</span>
                     <span class='kw'>elsif</span> <span class='id identifier rubyid_groupid'>groupid</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>studies</span><span class='tstring_end'>&quot;</span></span>
                         <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...searching Studies</span><span class='tstring_end'>&quot;</span></span>
   		          <span class='id identifier rubyid_tmp_study'>tmp_study</span> <span class='op'>=</span> <span class='const'>Study</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span><span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE ? OR </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> LIKE ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_q1'>q1</span><span class='comma'>,</span><span class='id identifier rubyid_q2'>q2</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                         <span class='comment'># for each study with a hit - pull the associated project and array of publications
</span>                         <span class='kw'>for</span> <span class='id identifier rubyid_study'>study</span> <span class='kw'>in</span> <span class='id identifier rubyid_tmp_study'>tmp_study</span>
                             <span class='comment'># construct the search hit context text
</span>                             <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='semicolon'>;</span>
                             <span class='kw'>if</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>title</span><span class='tstring_end'>&quot;</span></span>
                                 <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_study'>study</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='semicolon'>;</span>
                             <span class='kw'>end</span>
                                 
   	                      <span class='id identifier rubyid_prj'>prj</span> <span class='op'>=</span> <span class='const'>Project</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:first</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_study'>study</span><span class='period'>.</span><span class='id identifier rubyid_project_id'>project_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                             <span class='comment'># If a public search - only allow Project.is_public = boolean [f | t]
</span>                             <span class='kw'>if</span> <span class='lparen'>(</span><span class='op'>!</span><span class='id identifier rubyid_is_public_search'>is_public_search</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_user_id'>user_id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span> <span class='op'>==</span> <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_creator_id'>creator_id</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>||</span>
                                <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_is_public'>is_public</span>
                                 <span class='comment'># Pickup project information - creator, create date, etc
</span>       	                  <span class='id identifier rubyid_userinfo'>userinfo</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:first</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_prj'>prj</span><span class='period'>.</span><span class='id identifier rubyid_creator_id'>creator_id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                                 <span class='comment'># Pickup associated publications for this study
</span>   	                          <span class='id identifier rubyid_tmp_pub'>tmp_pub</span> <span class='op'>=</span> <span class='const'>PrimaryPublication</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='symbol'>:all</span><span class='comma'>,</span> <span class='symbol'>:conditions</span><span class='op'>=&gt;</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>study_id = ?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_study'>study</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span><span class='rparen'>)</span>
                                 <span class='id identifier rubyid_tmp_proj'>tmp_proj</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_prj'>prj</span><span class='comma'>,</span><span class='id identifier rubyid_qtext'>qtext</span><span class='comma'>,</span><span class='id identifier rubyid_study'>study</span><span class='comma'>,</span><span class='id identifier rubyid_tmp_pub'>tmp_pub</span><span class='comma'>,</span><span class='id identifier rubyid_tdesc'>tdesc</span><span class='comma'>,</span><span class='id identifier rubyid_userinfo'>userinfo</span><span class='comma'>,</span><span class='kw'>nil</span><span class='rbracket'>]</span>
                             <span class='kw'>end</span>
                         <span class='kw'>end</span>
                     <span class='kw'>else</span>
                         <span class='comment'># search group type not handled
</span>                     <span class='kw'>end</span>
                     
                     <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>found projects </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_tmp_proj'>tmp_proj</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> for qstr </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> on term </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_t'>t</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> i </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> of n_words </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_n_words'>n_words</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
                     <span class='comment'># iterate through all the projects found and tag it with a hit score if it was not already scored
</span>   	              <span class='kw'>for</span> <span class='id identifier rubyid_data'>data</span> <span class='kw'>in</span> <span class='id identifier rubyid_tmp_proj'>tmp_proj</span>
                         <span class='id identifier rubyid_proj'>proj</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
                         <span class='id identifier rubyid_qtext'>qtext</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span>
                         <span class='id identifier rubyid_study'>study</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span>
                         <span class='id identifier rubyid_tmp_pub'>tmp_pub</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='int'>3</span><span class='rbracket'>]</span>
                         <span class='id identifier rubyid_matchloc'>matchloc</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='int'>4</span><span class='rbracket'>]</span>
                         <span class='id identifier rubyid_userinfo'>userinfo</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='int'>5</span><span class='rbracket'>]</span>
                         <span class='comment'># Check to see if there is a list of associated projects
</span>                         <span class='id identifier rubyid_assocprjs'>assocprjs</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='semicolon'>;</span>
                         <span class='kw'>if</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>6</span>
                             <span class='id identifier rubyid_assocprjs'>assocprjs</span> <span class='op'>=</span> <span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='int'>6</span><span class='rbracket'>]</span>
                         <span class='kw'>end</span>
                         
                         <span class='comment'># Choose best match score by number of words and total characters matched, weight it by tscore
</span>                         <span class='id identifier rubyid_hitscore'>hitscore</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='int'>100</span> <span class='op'>*</span> <span class='id identifier rubyid_tscore'>tscore</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_n_words'>n_words</span> <span class='op'>-</span> <span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='lparen'>(</span><span class='int'>100</span> <span class='op'>*</span> <span class='id identifier rubyid_n_words'>n_words</span><span class='rparen'>)</span>
                         <span class='id identifier rubyid_charscore'>charscore</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='int'>100</span> <span class='op'>*</span> <span class='id identifier rubyid_tscore'>tscore</span> <span class='op'>*</span> <span class='id identifier rubyid_qstr'>qstr</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='lparen'>(</span><span class='int'>100</span> <span class='op'>*</span> <span class='id identifier rubyid_n_chars'>n_chars</span><span class='rparen'>)</span>
                         <span class='comment'># See if matched on big words versus a bunch of small words
</span>                         <span class='kw'>if</span> <span class='id identifier rubyid_charscore'>charscore</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_hitscore'>hitscore</span>
                             <span class='id identifier rubyid_hitscore'>hitscore</span> <span class='op'>=</span> <span class='id identifier rubyid_charscore'>charscore</span>
                         <span class='kw'>end</span>
                         <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>checking if </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_proj'>proj</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> is already in list </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_ret_projs'>ret_projs</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> hitscore = </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_hitscore'>hitscore</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
                         <span class='kw'>if</span> <span class='id identifier rubyid_ret_projs'>ret_projs</span><span class='lbracket'>[</span><span class='id identifier rubyid_proj'>proj</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span>
                             <span class='id identifier rubyid_ret_projs'>ret_projs</span><span class='lbracket'>[</span><span class='id identifier rubyid_proj'>proj</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_hitscore'>hitscore</span><span class='comma'>,</span> <span class='id identifier rubyid_proj'>proj</span><span class='comma'>,</span> <span class='id identifier rubyid_qtext'>qtext</span><span class='comma'>,</span> <span class='id identifier rubyid_study'>study</span><span class='comma'>,</span> <span class='id identifier rubyid_tmp_pub'>tmp_pub</span><span class='comma'>,</span> <span class='id identifier rubyid_matchloc'>matchloc</span><span class='comma'>,</span> <span class='id identifier rubyid_userinfo'>userinfo</span><span class='comma'>,</span> <span class='id identifier rubyid_assocprjs'>assocprjs</span><span class='rbracket'>]</span>
                             <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>... scoring hit on id </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_proj'>proj</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> n_words = </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_n_words'>n_words</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> i </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_i'>i</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> tscore </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_tscore'>tscore</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> --&gt; </span><span class='tstring_end'>&quot;</span></span><span class='op'>+</span><span class='id identifier rubyid_hitscore'>hitscore</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> 
                         <span class='kw'>elsif</span> <span class='id identifier rubyid_groupid'>groupid</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>projects</span><span class='tstring_end'>&quot;</span></span>
                             <span class='comment'># project_id was already found - just update the score if a better match was found
</span>                             <span class='comment'># covers situation where a longer match sequence was found in the description vs title
</span>                             <span class='comment'># Check to see if this hit has a higher score
</span>                             <span class='id identifier rubyid_prev_entry'>prev_entry</span> <span class='op'>=</span> <span class='id identifier rubyid_ret_projs'>ret_projs</span><span class='lbracket'>[</span><span class='id identifier rubyid_proj'>proj</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span>
                             <span class='id identifier rubyid_prevscore'>prevscore</span> <span class='op'>=</span> <span class='id identifier rubyid_prev_entry'>prev_entry</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
                             <span class='kw'>if</span> <span class='id identifier rubyid_prevscore'>prevscore</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_hitscore'>hitscore</span>
                                 <span class='id identifier rubyid_prev_entry'>prev_entry</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_hitscore'>hitscore</span>
                             <span class='kw'>end</span>
                         <span class='kw'>else</span>
                             <span class='comment'># Just add entry
</span>                             <span class='id identifier rubyid_ret_projs'>ret_projs</span><span class='lbracket'>[</span><span class='id identifier rubyid_proj'>proj</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_hitscore'>hitscore</span><span class='comma'>,</span> <span class='id identifier rubyid_proj'>proj</span><span class='comma'>,</span> <span class='id identifier rubyid_qtext'>qtext</span><span class='comma'>,</span> <span class='id identifier rubyid_study'>study</span><span class='comma'>,</span> <span class='id identifier rubyid_tmp_pub'>tmp_pub</span><span class='comma'>,</span> <span class='id identifier rubyid_matchloc'>matchloc</span><span class='comma'>,</span> <span class='id identifier rubyid_userinfo'>userinfo</span><span class='comma'>,</span> <span class='id identifier rubyid_assocprjs'>assocprjs</span><span class='rbracket'>]</span>
                         <span class='kw'>end</span>
   	              <span class='kw'>end</span>
                 
                     <span class='id identifier rubyid_k'>k</span> <span class='op'>=</span> <span class='id identifier rubyid_k'>k</span> <span class='op'>+</span> <span class='int'>1</span>
                 <span class='kw'>end</span> 
                 
                 <span class='comment'># go to the next group of words
</span>                 <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span>
             <span class='rparen'>)</span> <span class='kw'>until</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_n_words'>n_words</span>     
  <span class='kw'>end</span>
         <span class='comment'>#puts &quot;*********** results of search &quot;+ret_projs.to_s
</span>  <span class='kw'>return</span> <span class='id identifier rubyid_ret_projs'>ret_projs</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="toContextText-instance_method">
  
    - (<tt>Object</tt>) <strong>toContextText</strong>(tdata, q1) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <hr style="height: 10px"></hr><p>
Produce context text where q1 and/or q2 was found in tdata   
</p>
<hr style="height: 10px"></hr>

  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/search_controller.rb', line 107</span>

<span class='kw'>def</span> <span class='id identifier rubyid_toContextText'>toContextText</span><span class='lparen'>(</span><span class='id identifier rubyid_tdata'>tdata</span><span class='comma'>,</span><span class='id identifier rubyid_q1'>q1</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_tdata'>tdata</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='kw'>return</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>
    
    <span class='comment'># Since q1 is mixed caps, need to split using all caps and then re-construct using original fragments to preserve
</span>    <span class='comment'># original look of the text. Setup variables to to represent original (raw) and uppercase versions. Use upper case vars
</span>    <span class='comment'># to do splits
</span>    <span class='id identifier rubyid_rawtext'>rawtext</span> <span class='op'>=</span> <span class='id identifier rubyid_tdata'>tdata</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_cq1'>cq1</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_q1'>q1</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_cq1'>cq1</span> <span class='op'>=</span> <span class='id identifier rubyid_q1'>q1</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span>
    <span class='kw'>end</span>
    
    <span class='comment'># First laydown markers - where to split the text
</span>    <span class='id identifier rubyid_ctext'>ctext</span> <span class='op'>=</span> <span class='id identifier rubyid_tdata'>tdata</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_q1'>q1</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='id identifier rubyid_ctext'>ctext</span> <span class='op'>=</span> <span class='id identifier rubyid_ctext'>ctext</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='id identifier rubyid_cq1'>cq1</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;b&gt;q1&lt;/b&gt;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    
    <span class='comment'># Now condense surrounding text
</span>    <span class='id identifier rubyid_compstr'>compstr</span> <span class='op'>=</span> <span class='id identifier rubyid_ctext'>ctext</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;b&gt;q1&lt;/b&gt;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>if</span> <span class='id identifier rubyid_compstr'>compstr</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>1</span>
        <span class='id identifier rubyid_idx'>idx</span> <span class='op'>=</span> <span class='int'>0</span>
 <span class='id identifier rubyid_compstr'>compstr</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_comp'>comp</span><span class='op'>|</span>
            <span class='comment'># get the raw fragment - if zero length, set it to &quot;&quot;. Ruby takes neg index
</span>            <span class='kw'>if</span> <span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
                <span class='id identifier rubyid_rawcomp'>rawcomp</span> <span class='op'>=</span> <span class='id identifier rubyid_rawtext'>rawtext</span><span class='lbracket'>[</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span>
            <span class='kw'>else</span>
                <span class='id identifier rubyid_rawcomp'>rawcomp</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
            <span class='kw'>end</span>
            <span class='id identifier rubyid_rawq1'>rawq1</span> <span class='op'>=</span> <span class='id identifier rubyid_rawtext'>rawtext</span><span class='lbracket'>[</span><span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='op'>..</span><span class='lparen'>(</span><span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_q1'>q1</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span><span class='rbracket'>]</span>
            <span class='comment'># trim the raw text of the fragment + q1 text
</span>            <span class='id identifier rubyid_rawtext'>rawtext</span> <span class='op'>=</span> <span class='id identifier rubyid_rawtext'>rawtext</span><span class='lbracket'>[</span><span class='lparen'>(</span><span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_q1'>q1</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span><span class='op'>..</span><span class='id identifier rubyid_rawtext'>rawtext</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span>
            
            <span class='comment'># Just check and condense long components
</span>            <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_idx'>idx</span> <span class='op'>==</span> <span class='id identifier rubyid_compstr'>compstr</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>16</span><span class='rparen'>)</span>
                <span class='comment'># last component
</span>                <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>=</span> <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>+</span> <span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>16</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span>
            <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_rtext'>rtext</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>32</span><span class='rparen'>)</span>
                <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>=</span> <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>+</span> <span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>16</span><span class='rbracket'>]</span><span class='op'>+</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='lbracket'>[</span><span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>16</span><span class='comma'>,</span><span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span>
            <span class='kw'>elsif</span> <span class='id identifier rubyid_comp'>comp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>16</span>
                <span class='comment'># first component and long
</span>                <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>=</span> <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='lbracket'>[</span><span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>16</span><span class='comma'>,</span><span class='id identifier rubyid_rawcomp'>rawcomp</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span>
            <span class='kw'>else</span>
                <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>=</span> <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>+</span> <span class='id identifier rubyid_rawcomp'>rawcomp</span>
            <span class='kw'>end</span>
            <span class='comment'># If this is not the last component - add the bold q1
</span>            <span class='kw'>if</span> <span class='id identifier rubyid_idx'>idx</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_compstr'>compstr</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>1</span>
                <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>=</span> <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;font color=\&quot;red\&quot;&gt;&lt;b&gt;&lt;i&gt;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_rawq1'>rawq1</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;/i&gt;&lt;/b&gt;&lt;/font&gt;</span><span class='tstring_end'>&quot;</span></span>
            <span class='kw'>end</span>
            
            <span class='id identifier rubyid_idx'>idx</span> <span class='op'>=</span> <span class='id identifier rubyid_idx'>idx</span> <span class='op'>+</span> <span class='int'>1</span>
        <span class='kw'>end</span>
    <span class='kw'>else</span>
        <span class='comment'># No splits found - just return original text
</span>        <span class='id identifier rubyid_rtext'>rtext</span> <span class='op'>=</span> <span class='id identifier rubyid_rawtext'>rawtext</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_rtext'>rtext</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Wed Feb  1 16:26:50 2012 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.4 (ruby-1.9.2).
</div>

  </body>
</html>